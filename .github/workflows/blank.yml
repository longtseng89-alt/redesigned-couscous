name: Tailscale + Run Python Counter

on:
  workflow_dispatch:

jobs:
  setup-tailscale-and-run:
    runs-on: windows-latest
    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Download Tailscale installer
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile "tailscale-setup.exe"

      - name: Install Tailscale (silent)
        shell: pwsh
        run: |
          Start-Process -FilePath ".\tailscale-setup.exe" -ArgumentList "/quiet" -Wait

      - name: Start Tailscale and connect
        shell: pwsh
        env:
          TAILSCALE_AUTHKEY: tskey-auth-knr5x4zWo221CNTRL-ozxcHnuP1SifzU1cTHYASiSyy54pjnhBg
        run: |
          $ts = "C:\Program Files\Tailscale\tailscale.exe"
          if (-Not (Test-Path $ts)) {
            Write-Error "tailscale.exe not found at expected path: $ts"
            exit 1
          }
          & $ts up --authkey $env:TAILSCALE_AUTHKEY --accept-routes --accept-dns

      - name: Create Python counter script
        shell: pwsh
        run: |
          @"
import os
import time

def main():
    show = os.getenv("SHOW_PROGRESS", "0") == "1"
    i = 0
    inc = 1
    _i = i
    _inc = inc

    if show:
        mask = 0xFFFFFF
        last = time.time()
        while True:
            _i += _inc
            if (_i & mask) == 0:
                now = time.time()
                print(f"count={_i}  elapsed={now-last:.2f}s")
                last = now
    else:
        while True:
            _i += _inc

if __name__ == "__main__":
    main()
"@ | Set-Content -Path count_infinite.py -Encoding UTF8

      - name: Run Python counter (max speed, no prints)
        shell: pwsh
        run: |
          python .\count_infinite.py
